management:
  endpoints:
    web:
      exposure:
        include: health,metrics,prometheus
  endpoint:
    health:
      show-details: when-authorized
  # Distributed tracing: track a request across gateway and downstream services (X-B3-* headers).
  # Crucial for debugging latency and understanding call flows.
  tracing:
    sampling:
      probability: 1.0   # development: sample all; in production use a lower value (e.g. 0.1)
  zipkin:
    tracing:
      endpoint: http://localhost:9411/api/v2/spans

spring:
  # Redis: used by the gateway for distributed rate limiting (token bucket).
  data:
    redis:
      host: localhost
      port: 6379
  # Request rate limiter: add X-RateLimit-* headers to responses for client visibility.
  # Token bucket: replenish-rate = tokens per second; burst-capacity = max tokens per key (user or IP).
  cloud:
    gateway:
      rate-limiter:
        replenish-rate: 10   # sustained request rate per second per key
        burst-capacity: 20   # max burst (allows short spikes above replenish-rate)
      filter:
        request-rate-limiter:
          include-headers: true
  security:
    oauth2:
      resourceserver:
        jwt:
          # Development: Keycloak realm issuer (adjust port if your IdP runs elsewhere).
          issuer-uri: http://localhost:8080/auth/realms/searoute
          # Optional: override JWK Set URI if discovery is not used (e.g. same host as issuer).
          # jwk-set-uri: http://localhost:8080/auth/realms/searoute/protocol/openid-connect/certs

# -----------------------------------------------------------------------------
# Resilience4j Circuit Breaker (used by ReactiveCircuitBreakerFactory)
# -----------------------------------------------------------------------------
# Instance names must match the string passed to factory.create("name") in each proxy:
#   bookingService, trackingService, scheduleService.
# Spring Cloud Circuit Breaker auto-configuration binds these properties and
# ReactiveResilience4JCircuitBreakerFactory uses them when create(instanceName) is called.
resilience4j:
  circuitbreaker:
    instances:
      bookingService:
        slidingWindowSize: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 10s
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
      trackingService:
        slidingWindowSize: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 10s
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
      scheduleService:
        slidingWindowSize: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 10s
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3
      paymentService:
        slidingWindowSize: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 10s
        minimumNumberOfCalls: 5
        permittedNumberOfCallsInHalfOpenState: 3

# -----------------------------------------------------------------------------
# Backend service base URLs (for WebClient proxies)
# -----------------------------------------------------------------------------
# When using Eureka, these can be replaced with lb://BOOKING-SERVICE etc. via discovery.
searoute:
  backend:
    booking-base-url: http://localhost:8081
    tracking-base-url: http://localhost:8082
    schedule-base-url: http://localhost:8083
    payment-base-url: http://localhost:8084
